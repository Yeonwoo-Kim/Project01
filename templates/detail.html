<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href='../static/css/style.css' rel="stylesheet">
    <link rel="stylesheet" href="../static/css/dark.css" type="text/css"/>
    <link rel="stylesheet" href="../static/css/swiper.css" type="text/css"/>
    <link rel="stylesheet" href="../static/css/font-icons.css" type="text/css"/>

    <!--    <link rel="preconnect" href="https://fonts.gstatic.com">-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

</head>
<body class="kk stretched bg-color2 has-plugin-bootstrap" data-loader="4" data-loader-color="theme">
<div id="wrapper" class="clearfix">

    <!-- Header
    ============================================= -->


    <!-- Content
    ============================================= -->
    <section id="content">
        <div class="content-wrap">

            <div class="container clearfix bg">

                <div class="row">
                    <div class="col-lg-12 bottommargin">

                        <div class="row col-mb-50">


                            <div class="col-12">

                                <div class="posts-md">
                                    <div class="entry row mb-5">
                                        <div class="col-md-4">
                                            <div class="entry-image">
                                                <a href="" style="width: 80%;margin:20px"><img
                                                        src="{{ doc['albumArt'] }}"
                                                        alt="Image"></a>
                                            </div>
                                        </div>
                                        <div class="col-md-8 mt-3 mt-md-0">
                                            <div class="portfolio-desc">
                                                <span class="font-primary text-uppercase">{{ doc['artist'] }}</span>
                                                <h3><a href="#">{{ doc['title'] }}</a></h3>
                                            </div>
                                            <div class="col-md-8">
                                                <table class="table table-hover">

                                                    <tbody>

                                                    <tr>
                                                        <th>장르</th>
                                                        <td>{{ doc['genre'] }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>발매일</th>
                                                        <td>{{ doc['release_date'] }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>좋아요</th>
                                                        <td>{{ doc['like'] }}</td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr>

                            </div>


                        </div>


                    </div>

                </div>


            </div>

        </div>

    </section>

    <section id="content" class="pb-4">
        <div class="container clearfix bg">
            <div class="row">
                <div class="col-lg-12 ">
                    <div class="row col-mb-50">
                        <div class="col-12" style="padding:20px 20px">
                            <div class="posts-md">
                                <div class="col-md-12 mt-3 mb-sm-4 form-row">
                                    <div class="col-xs-12 col-md-12" style="display: flex">
                                        <input id="textarea-post" style="width:95%; margin-right: 20px"
                                               class="form-control" type="text"
                                               placeholder="자유롭게 의견을 적어주세요.">
                                        <input id="mId" value="{{ doc['mId'] }}" type="hidden">
                                        <button class="btn button-small" onclick="post()">등록</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12 ">
                            <div class="row col-mb-50">
                                <div class="col-12">
                                    <div class="posts-md">
                                        <div class="col-md-12 mt-3 mb-sm-4 " id="post-box">
                                            <div class="box" id="" style="background-color:rgba(255,255,255,0.7)">
                                                <article class="media">
                                                    <div class="media-left">
                                                        <a class="image is-64x64" href="/wp/sweeter/user/s2curity">
                                                            <img class="is-rounded"
                                                                 src="/static/images/profile_pics/profile_placeholder.png"
                                                                 alt="Image">
                                                        </a>
                                                    </div>
                                                    <div class="media-content">
                                                        <div class="content">
                                                            <p>
                                                                <strong>s2curity</strong> <small>@s2curity</small>
                                                                <small>59분 전</small>
                                                                <br>
                                                                아무 생각하지 않고 있습니다.
                                                            </p>
                                                        </div>
                                                        <nav class="level is-mobile">
                                                            <div class="level-left">
                                                                <a class="level-item is-sparta" aria-label="heart"
                                                                   onclick="toggle_like('60bf3945fe695b3a633cd3b2', 'heart')">
                                                                    <span class="icon is-small"><i
                                                                            class="icon-heart-empty"
                                                                            aria-hidden="true"></i></span>&nbsp;<span
                                                                        class="like-num">1</span>
                                                                </a>

                                                            </div>

                                                        </nav>
                                                    </div>
                                                </article>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </section>
    <footer id="footer" class="border-0 dark" style="background-color: #111;">
        <!-- Copyrights
        ============================================= -->
        <div id="copyrights" style="color: #444;">
            <div class="container clearfix">

                <div class="row justify-content-between col-mb-30">
                    <div class="col-12 col-lg-auto text-center text-lg-left">
                        Copyrights &copy; 2020 All Rights Reserved by hansarang.
                    </div>

                </div>

            </div>
        </div><!-- #copyrights end -->
    </footer><!-- #footer end -->
</div>

<script>
    $(document).ready(function () {
        get_posts()

    })


    function post() {
        if(confirm("리뷰를 등록하시겠습니까?")) {
            let comment = $("#textarea-post").val()
            let today = new Date().toISOString()
            let mId = $("#mId").val()
            $.ajax({
                type: "POST",
                url: "/posting",
                data: {
                    comment_give: comment,
                    date_give: today,
                    mId: mId
                },
                success: function (response) {
                    $("#modal-post").removeClass("is-active")
                    window.location.reload()
                }
            })
        }
        else{
            return;
        }
    }

    function get_posts() {

            $("#post-box").empty()
            $.ajax({
                type: "GET",
                url: `/get_posts?mId={{doc['mId']}}`,
                data: {},
                success: function (response) {
                    if (response["result"] == "success") {
                        let posts = response["posts"]
                        let name = 'qwer1234'
                        for (let i = 0; i < posts.length; i++) {
                            let post = posts[i]
                            let time_post = new Date(post["date"])
                            let time_before = time2str(time_post)

                            let class_heart = post['heart_by_me'] ? "fa-heart" : "fa-heart-o"
                            let class_star = post['star_by_me'] ? "fa-star" : "fa-star-o"
                            let class_like = post['like_by_me'] ? "fa-thumbs-up" : "fa-thumbs-o-up"

                            let html_temp = `<div class="box" id="${post["_id"]}">
                                        <article class="media">
                                            <div class="media-left">
                                            </div>
                                            <div class="media-content">
                                                <div class="content">
                                                    <p>
                                                        <strong >${post['profile_name']}</strong> <small>@${post['username']}</small> <small>${time_before}</small>
                                                        <br>
                                                        ${post['comment']}
                                                    </p>
                                                </div>
                                                <nav class="level is-mobile">
                                                    <div class="level-left">
                                                        <a class="level-item is-sparta" aria-label="heart" onclick="toggle_like('${post['_id']}', 'heart')">
                                                            <span class="icon is-small"><i class="fa ${class_heart}"
                                                                                           aria-hidden="true"></i></span>&nbsp;<span class="like-num">${num2str(post["count_heart"])}</span>
                                                        </a>
                                                        {% if user_info['username'] == name  %}
                                                            <a class="level-item is-sparta" aria-label="heart" onclick="toggle_like('${post['_id']}', 'heart')">
                                                                <span class="icon is-small"><i class="fa ${class_heart}"aria-hidden="true"></i></span>&nbsp;<span class="like-num">${num2str(post["count_heart"])}</span>
                                                            </a>
                                                        {% endif %}
                                                   </div>
                                                </nav>
                                            </div>
                                        </article>
                                    </div>`
                            $("#post-box").append(html_temp)
                        }
                    }
                }
            })
    }

    function time2str(date) {
        let today = new Date()
        let time = (today - date) / 1000 / 60  // 분

        if (time < 60) {
            return parseInt(time) + "분 전"
        }
        time = time / 60  // 시간
        if (time < 24) {
            return parseInt(time) + "시간 전"
        }
        time = time / 24
        if (time < 7) {
            return parseInt(time) + "일 전"
        }
        return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`
    }

    function num2str(count) {
        if (count > 10000) {
            return parseInt(count / 1000) + "k"
        }
        if (count > 500) {
            return parseInt(count / 100) / 10 + "k"
        }
        if (count == 0) {
            return ""
        }
        return count
    }

    function toggle_like(post_id, type) {
        console.log(post_id, type)
        let $a_like = $(`#${post_id} a[aria-label='${type}']`)
        let $i_like = $a_like.find("i")
        let class_s = {"heart": "fa-heart", "star": "fa-star", "like": "fa-thumbs-up"}
        let class_o = {"heart": "fa-heart-o", "star": "fa-star-o", "like": "fa-thumbs-o-up"}
        if ($i_like.hasClass(class_s[type])) {
            $.ajax({
                type: "POST",
                url: "/update_like",
                data: {
                    post_id_give: post_id,
                    type_give: type,
                    action_give: "unlike"
                },
                success: function (response) {
                    console.log("unlike")
                    $i_like.addClass(class_o[type]).removeClass(class_s[type])
                    $a_like.find("span.like-num").text(num2str(response["count"]))
                }
            })
        } else {
            $.ajax({
                type: "POST",
                url: "/update_like",
                data: {
                    post_id_give: post_id,
                    type_give: type,
                    action_give: "like"
                },
                success: function (response) {
                    console.log("like")
                    $i_like.addClass(class_s[type]).removeClass(class_o[type])
                    $a_like.find("span.like-num").text(num2str(response["count"]))
                }
            })

        }
    }

</script>
<script src="../static/js/functions.js"></script>
<script src="../static/js/plugins.min.js"></script>

</body>
</html>